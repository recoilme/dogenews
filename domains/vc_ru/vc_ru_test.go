package vc_ru

import (
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
)

func Test_Split(t *testing.T) {
	str := "https://vc.ru/marketing/232215-propali-lidy-kuda-smotret-chek-list-na-19-punktov https://vc.ru/services/231736-otvlechsya-ot-ekranov-pochemu-audioigry-dlya-detey-i-vzroslyh-stali-populyarnee-v-pandemiyu https://vc.ru/life/232225-kak-protivostoyat-gigantam https://vc.ru/social/232230-neizvestnye-sostavili-bazu-publichnyh-dannyh-1-3-mln-polzovateley-clubhouse-i-vylozhili-ee-v-otkrytyy-dostup https://vc.ru/hr/232224-pochemu-pereryvy-na-kofe-strashnee-samih-vstrech-chto-nuzhno-znat-pro-small-talk https://vc.ru/finance/232213-3-fakta-pered-ipo-alkami-technology-ipo-alkt https://vc.ru/opinions/230178-chto-obshchego-u-nikolaya-ii-pylesosa-i-dzheffa-bezosa https://vc.ru/offline/232207-mechtaete-o-lichnom-issledovatelskom-sudne https://vc.ru/finance/232201-kto-lyubit-serebro-krupneyshie-igroki-industrii-chast-1 https://vc.ru/life/232168 https://vc.ru/migrate/232146-razrabotchik-v-singapure-pochemu-yugo-vostochnaya-aziya-nedoocenena https://vc.ru/finance/231675-priyatel-pomogayushchiy-rasplatitsya"
	urls := strings.Split(str, " ")
	assert.NotEqual(t, 10, len(urls))
	vc := New("vc.ru")
	for _, url := range urls {
		res, _ := vc.LinkOk(url, false)
		if len([]rune(res)) > 30 {
			t.Error("long res:", res)
		}
	}
}

func Test_Article(t *testing.T) {
	vc := New("vc.ru")
	txt := `В статье расскажу, куда смотреть, если вдруг пропали лиды из контекстной рекламы. Полезно почитать и маркетологам и бизнесу. Привет, меня зовут Александр, я специалист по контекстной рекламе и работаю с автодилером. Часто бывает так, что сегодня по лидам густо — а завтра пусто и у заказчика возникает вопрос — wtf? Рассмотрим 19 пунктов чек-листа для проверки. Ссылка на чек-лист в Google Docs — в конце статьи. Проверяем работу рекламных кампаний 1. Не хватает ставки, упал объем выкупаемого трафика или конкуренты выбили из спецразмещения Частая проблема, когда конкуренты разогрели аукцион, или пришел кто-то новый и решил выкупать весь трафик. Вашей ставки уже не хватает для выкупа прежнего объема трафика и соответственно количество лидов проседает. Что делать? Для Яндекса: Проверить, хватает ли ставок для попадания в спецразмещение. Посмотреть отчет по объему трафика, позиции показа и позиции клика и сравнить с предыдущим периодом. Смотрим отчет в Директе Для Google: Проверить % полученных показов % показов на верхней позиции Смотрим отчет в Google Ads Если есть сильная просадка — увеличиваем ставки, работаем над повышением релевантности и качеством объявлений. 2. Не хватает дневного бюджета Раньше, вашего бюджета хватало на целый день, а сейчас бюджет может заканчиваться в обед. Трафик падает = заявок нет. Проверьте колебания трафика в течении дня по каждой РК через Яндекс Метрику в отчете по времени суток. Смотрим отчет в Яндекс метрике 3. Баг дневного бюджета в Директе В Директе, есть такая интересная штука, как “баг дневного бюджета”. В чем заключается — например дневной бюджет на РК стоит 500 руб., а ставку на ключ вы поставили 501 руб. = все, кампания как-бы работает, иногда есть показы и клики, но по факту она “встала”. В двух словах — ставка на ключ не может быть больше дневного бюджета, т.е бюджета должно хватить на “несколько кликов”. Что делать: либо уменьшать ставку, либо увеличивать дневной бюджет. Распознать такую штуку можно через техподдержку Яндекса. Симптомы: вроде-бы все ок, но трафик почти исчез, непонятно, но почему-то реклама не показывается. В отчетах все ок = объем на месте, все на месте. Частая проблема, когда работаете с биддерами по стратегии CPC и сервисами автоматизации контекста. 4. При оптимизации отключили профитные ключевые фразы или объявления При оптимизации, отключили, казалось бы неэффективные слова или объявления. Частый косяк, в случаях, когда не отслеживаются ассоциированные конверсии, цикл сделки долгий или не отслеживаются звонки с тех-же визиток (или в целом не отслеживаются звонки). Вроде бы смотришь отчет — ключ/объявление жрет бюджет, а заявок/звонков нет. Отключаешь. Количество лидов постепенно проседает. Что делать: пересобрать РК или откатиться по изменениям назад (что не всегда возможно). А еще, РСЯ, любит “ломаться” при отключении объявлений/ключей и резать охват. 5. Исчезли показы рекламы В отчетах все хорошо — объем трафика не изменился, позиции тоже, но показы и клики просели. Проверьте руками выдачу в инкогнито в течении дня несколько раз и узнайте, есть ли показы ваших объявлений. Бывает, что немного показов и кликов есть, и ты думаешь — наверное объем трафика низкий или все просело из-за сезонности/спроса. Смотришь отчет на объем трафика = там все ок, 90-100%. Смотришь ключи на сезонность — тоже все ок. А по факту, может быть какой-то баг (например со ставкой и дневным бюджетом) или еще что-то, что тупо реклама не показывается. Что делать: позвонить в техподдержку/пересобрать РК. 6. Закончились деньги Такое тоже бывает. Первым делом проверьте, не закончился ли бюджет в аккаунте рекламной системы. 7. Модерация отклонила все объявления Крутишь рекламу несколько месяцев, вроде все ок, ниша белая. Бум — робот Яндекса отклоняет все РК в аккаунте (хорошо если не по п.15). Проверить легко — войти в аккаунт и чекнуть, а вот решить проблему не всегда легко, приходится звонить и бодаться с ТП Яндекса/Гугла. А если это будет п. 15 в Директе — то труба. Так бывает из-за багов робота модерации либо новых правил для некоторых ниш, что в Я, что в G. 8. Не работает РК дающая лиды Проверьте, работает ли рекламная кампания, которая давала основную долю лидов. Хватает ли ей дневного бюджета — не забирают ли другие РК весь бюджет. Бывает так, что к примеру работают 3 РК и кто-то начинает сжирать весь бюджет, не оставляя другим. Что делать: посмотреть, какие РК стали давать львиную долю трафика и пофиксить проблему. Проверяем сайт и оффер 1. Сменился оффер на сайте или в объявлениях Недавно поменяли основное УТП или главный оффер на сайте/в объявлениях? Сопоставьте даты и посмотрите, может быть, новое УТП никому не интересно и не дает конверсий. Менять УТП или "офферы" желательно через A/B тесты, с помощью инструментов “Эксперименты” в Я и Г и сервиса Google Optimize. 2. Отвалились формы Работают ли формы на сайте, отправляются ли данные с форм, приходят ли заявки на почту или в CRM — это первое, что нужно проверять, когда просело количество заявок. 3. Отвалились телефоны Используете коллтрекинг или SIP — прозвоните номера, вполне возможно, что они отвалились и не работает перенаправление (или вы забыли их оплатить). 4. У товара или услуги сезонный спрос Проверяйте сезонность хотя-бы основных запросов через Яндекс Wordstat и Google Trends. Колебания сезонного спроса могут быть там, где даже и не подозреваешь. Инструменты для проверки: Wordstat Google Trends 5. Что-то с сайтом Работает ли сайт корректно на всех устройствах, не режет ли его роскомнадзор, код ответа страниц 200? А может быть верстка сломалась на мобильных? Обязательно проверяйте адаптивность и корректность верстки на всех устройствах и разрешениях, проверьте, пингуется ли сайт с разных провайдеров. Инструменты для проверки кода ответа: Инструмент вебмастера в Яндекс: Можно проверить как видят ваш сайт разные роботы Яндекса Для проверки верстки: Режим “просмотр кода” в Google Chrome + уменьшаем окошко и смотрим как ведет себя верстка. Тянем окошко, уменьшаем и смотрим, как ведет себя верстка. 6. В нише отложенный спрос Все просто. В вашей нише срок принятия решения — несколько месяцев, в начале вы наливаете трафик, а потом собираете заявки. Люди присматриваются, сравнивают цены, условия, выгоды и только потом могут обратиться к вам. Недвижка, автомобили, b2b и пр. дорогие товары/услуги. Кстати, для примера, можно посмотреть отчет в Метрике, через сколько дней после посещения сайта была оставлена заявка/сделан звонок: Пример автодилера, цели — заявка или звонок Если у вас отложенный спрос или клиент долго принимает решение — не надо дергаться и паниковать, что прямо сейчас нет лидов. Нужно выстраивать маркетинговую стратегию, отрабатывать все этапы воронки, собирать "аудиторию" и работать с ней. 7. Появились негативные отзывы в сети Проверьте выдачу Яндекса и Гугла, оценки на картах, в каталогах и справочниках — не появились ли там жесткие негативные отзывы, из-за которых к вам никто не хочет обращаться. Негатив может резко обрубить поток лидов. Трафик есть = а заявок нет. Хотя, при появлении негатива, чаще всего падает конверсия в продажи. 8. Конкурент улучшил оффер Проверьте основных конкурентов: 1. Не уронили ли они цены. 2. Не выкатили ли убийственное УТП, которое меняет весь расклад в вашей нише. 3. Что у них показывается в объявлениях. В двух словах — проверьте сайт конкурентов и заголовки объявлений на новое УТП. 9. Конкурент улучшил сайт Ваш сайт старый и давно не обновлялся, у вас не удобно делать заказ, сложно найти контакты или форма с 100500 полями? А может быть с десяток виджетов с всплывающими окнами, чатами? Проверьте конкурента, может быть, у него стало проще сделать заказ, сайт стал удобнее, улучшился пользовательский путь, расширилась матрица товаров, все товары в наличии (а у вас нет), конкурент поумнел и убрал миллион бесполезных виджетов и теперь он забирает все лиды в нише? 10. Отвалилась аналитика или CRM Проверьте, не менялся ли код на сайте, все ли интеграции корректно работают, отрабатывает ли "события" ваша система аналитики, падают ли тестовые лиды в CRM. 11. Просто пропал спрос или ушел тренд Ничто не вечно. Пропал спрос, повысился курс доллара, изменилась политика партии, ушел тренд, изменился покупательский путь, покупательская способность, упали реальные доходы у вашей ЦА и ваш товар/услуга ушла на второй план. Что делать — искать варианты для повышения спроса, меняться, подстраиваться или понять и простить. Выводы и ссылка на чек-лист Никогда не паникуйте, если количество заявок вдруг просело. Спокойно проверьте рекламу, сайт, разложите все по "полочкам". Никогда не бывает так, что в течении года у вас будет стабильно условных 10 лидов в день без колебаний. Всегда будут просадки. Чек-лист в Google Docs можете забрать тут — ссылка. Также, подписывайтесь на мой телеграм канал, где я пишу небольшие статьи о контекстной рекламе (фишки, чек-листы и пр.).`
	a, err := vc.Article("https://vc.ru/marketing/232215")
	assert.NoError(t, err)
	assert.Equal(t, "Пропали лиды, куда смотреть? Чек-лист на 19 пунктов", a.Title)
	assert.Equal(t, "В статье расскажу, куда смотреть, если вдруг пропали лиды из контекстной рекламы. Полезно почитать и маркетологам и бизнесу.", a.Summary)
	assert.Equal(t, "https://vc.ru/cover/fb/c/232215/1618133318/cover.jpg", a.ImageBanner)
	assert.Equal(t, "width=600&height=315", a.ImageBannerMeta)
	assert.Equal(t, "2021-04-11 12:28:38 +0300 MSK", a.DatePub.String())
	assert.Equal(t, "маркетинг", a.Category)
	assert.Equal(t, true, a.CntView > 3000)
	assert.Equal(t, true, a.CntLike > 20)
	assert.Equal(t, true, a.CntComm > 10)
	assert.Equal(t, "Александр Алашеев", a.AuthorName)
	assert.Equal(t, "https://leonardo.osnova.io/960b64d1-9f1d-3b66-a65f-a4109947a1b9/-/scale_crop/64x64/", a.AuthorAva)
	assert.Equal(t, txt, a.ContentText)
}

func Test_Article2(t *testing.T) {
	vc := New("vc.ru")
	a, err := vc.Article("https://vc.ru/hr/243351")
	assert.NoError(t, err)
	assert.Equal(t, true, a.CntLike < 20)
}

func Test_LinkOk(t *testing.T) {
	str := "https://vc.ru/marketing/232215-propali-lidy-kuda-smotret-chek-list-na-19-punktov https://vc.ru/services/231736-otvlechsya-ot-ekranov-pochemu-audioigry-dlya-detey-i-vzroslyh-stali-populyarnee-v-pandemiyu https://vc.ru/life/232225-kak-protivostoyat-gigantam https://vc.ru/social/232230-neizvestnye-sostavili-bazu-publichnyh-dannyh-1-3-mln-polzovateley-clubhouse-i-vylozhili-ee-v-otkrytyy-dostup https://vc.ru/hr/232224-pochemu-pereryvy-na-kofe-strashnee-samih-vstrech-chto-nuzhno-znat-pro-small-talk https://vc.ru/finance/232213-3-fakta-pered-ipo-alkami-technology-ipo-alkt https://vc.ru/opinions/230178-chto-obshchego-u-nikolaya-ii-pylesosa-i-dzheffa-bezosa https://vc.ru/offline/232207-mechtaete-o-lichnom-issledovatelskom-sudne https://vc.ru/finance/232201-kto-lyubit-serebro-krupneyshie-igroki-industrii-chast-1 https://vc.ru/life/232168 https://vc.ru/migrate/232146-razrabotchik-v-singapure-pochemu-yugo-vostochnaya-aziya-nedoocenena https://vc.ru/finance/231675-priyatel-pomogayushchiy-rasplatitsya"
	vc := New("vc.ru")
	res, ok := vc.LinkOk(str, false)
	assert.Equal(t, ok, true)
	assert.Equal(t, "https://vc.ru/232215", res)
}
